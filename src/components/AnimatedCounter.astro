---
// Animated counter component for aBotSpot
// Shows incremental donations with subtle animation
---

<div
  data-target={Astro.props.target || 0}
  data-prefix={Astro.props.prefix || ''}
  data-suffix={Astro.props.suffix || ''}
  data-duration={Astro.props.duration || 2000}
  class="animated-counter text-4xl md:text-5xl font-bold text-blue-600"
>
  {(Astro.props.target || 0).toLocaleString()}
</div>

<style>
  /* Respect user's motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .animated-counter {
      animation: none !important;
      transition: none !important;
    }
  }
</style>

<script define:vars={{ target: Astro.props.target || 0, prefix: Astro.props.prefix || '', suffix: Astro.props.suffix || '', duration: Astro.props.duration || 2000 }}>
  (function() {
    class AnimatedCounter extends HTMLElement {
      constructor() {
        super();
        this.target = parseFloat(this.dataset.target);
        this.prefix = this.dataset.prefix || '';
        this.suffix = this.dataset.suffix || '';
        this.duration = parseInt(this.dataset.duration) || 2000;
        this.observer = null;
      }

      connectedCallback() {
        this.textContent = this.prefix + '0' + this.suffix;

        this.observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              this.animateCounter();
              this.observer.unobserve(this);
            }
          });
        }, { threshold: 0.5 });

        this.observer.observe(this);
      }

      disconnectedCallback() {
        if (this.observer) {
          this.observer.disconnect();
        }
      }

      animateCounter() {
        const startTime = performance.now();
        const startValue = 0;
        const endValue = this.target;

        const animate = (currentTime) => {
          const elapsed = currentTime - startTime;
          const progress = Math.min(elapsed / this.duration, 1);
          const easeOutExpo = 1 - Math.pow(2, -10 * progress);
          const current = startValue + (endValue - startValue) * easeOutExpo;

          this.textContent = this.prefix + Math.floor(current).toLocaleString() + this.suffix;

          if (progress < 1) {
            requestAnimationFrame(animate);
          }
        };

        requestAnimationFrame(animate);
      }
    }

    customElements.define('animated-counter', AnimatedCounter);
  })();
</script>
